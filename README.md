# Веб-сервис чата с интеграцией 1С

Веб-сервис для организации коммуникаций между студентами и преподавателями через веб-чат с интеграцией в учебную информационную систему 1С:Предприятие.

## Технологический стек

- **Frontend**: Next.js (React)
- **Backend**: Node.js + Express
- **База данных**: PostgreSQL
- **WebSocket**: Socket.io для реального времени
- **Интеграция**: REST API для синхронизации с 1С

## Структура проекта

```
app/
├── backend/          # Express API сервер
├── frontend/         # Next.js приложение
├── database/         # SQL схемы и начальные данные
│   ├── schema.sql    # Полная схема БД (актуальная, выполняется автоматически)
│   └── seeds.sql     # Начальные данные
├── 1scfg/           # Конфигурация и документация интеграции с 1С
└── docs/            # Документация
```

## Быстрый старт

1. Запустите базу данных в Docker:
```bash
docker-compose up -d postgres
```

2. Настройте переменные окружения (см. раздел ниже)

3. Запустите backend и frontend (см. разделы ниже)

## Установка и запуск

### Требования

- Node.js 16+
- Docker и Docker Compose
- 1С:Предприятие (учебная версия) с настроенным HTTP-сервисом

### Настройка переменных окружения

Создайте файл `.env` в корне проекта:

Отредактируйте `.env` и укажите:
- Параметры подключения к PostgreSQL (по умолчанию для Docker):
  - `DB_HOST=localhost` (или `postgres` при запуске backend в Docker)
  - `DB_PORT=5432`
  - `DB_NAME=chat_service_db`
  - `DB_USER=postgres`
  - `DB_PASSWORD=postgres`
- JWT_SECRET (измените на случайный ключ)
- ONE_C_API_URL (URL вашего HTTP-сервиса 1С)
- Настройки SMTP для отправки email (опционально, для обратной связи):
  - `SMTP_HOST=smtp.example.com` (например, smtp.gmail.com, smtp.mail.ru)
  - `SMTP_PORT=587` (обычно 587 для TLS или 465 для SSL)
  - `SMTP_SECURE=false` (true для порта 465, false для 587)
  - `SMTP_USER=your-email@example.com`
  - `SMTP_PASSWORD=your-password` (или app password для Gmail)
  - `SMTP_FROM_EMAIL=your-email@example.com` (от какого email отправлять, по умолчанию SMTP_USER)
  - `SMTP_FROM_NAME=Веб-сервис чата` (имя отправителя)
  
  **Примечание**: Если SMTP не настроен, ответы на обращения будут сохраняться в базе данных, но email не будет отправляться.

### База данных (Docker)

База данных запускается в отдельном Docker-контейнере:

1. Запустите контейнер PostgreSQL:
```bash
docker-compose up -d postgres
```

2. База данных будет автоматически инициализирована:
   - Схема `database/schema.sql` выполнится автоматически при первом запуске
   - Начальные данные из `database/seeds.sql` загрузятся автоматически
   - Данные сохраняются в Docker volume `postgres_data`

3. Проверьте статус контейнера:
```bash
docker-compose ps
```

4. Для просмотра логов:
```bash
docker-compose logs postgres
```

5. Для остановки базы данных:
```bash
docker-compose stop postgres
```

6. **Для полного удаления контейнера и данных (для чистой переустановки)**:
```bash
docker-compose down -v
```
Эта команда удалит контейнер и volume с данными. При следующем запуске база будет создана заново.

**Важно**: PostgreSQL выполняет скрипты инициализации (`schema.sql` и `seeds.sql`) **только при первом запуске**, когда директория данных пуста. Если volume уже содержит данные, скрипты не выполняются.

**Для пересоздания базы данных с нуля:**

1. Остановите и удалите контейнер вместе с volume:
```bash
docker-compose down -v
```

2. Проверьте, что volume удален (опционально):
```bash
docker volume ls | grep postgres_data
```
Если volume все еще существует, удалите его вручную:
```bash
docker volume rm app_postgres_data
```

3. Запустите контейнер заново:
```bash
docker-compose up -d postgres
```

Теперь база данных будет создана заново с чистой схемой и начальными данными.

**Примечание**: При первом запуске контейнер автоматически создаст базу данных и выполнит схему. Миграции не требуются, так как `schema.sql` уже содержит все необходимые таблицы.

### Backend

```bash
cd backend
npm install
npm run dev
```

Сервер запустится на `http://localhost:3001`

**Важно**: Убедитесь, что контейнер PostgreSQL запущен перед запуском backend:
```bash
docker-compose up -d postgres
```

### Frontend

```bash
cd frontend
npm install
npm run dev
```

Приложение запустится на `http://localhost:3000`

## Интеграция с 1С

### Настройка

1. Убедитесь, что HTTP-сервис 1С настроен и доступен по адресу, указанному в `ONE_C_API_URL`
2. По умолчанию используется `http://localhost:3040/PD/hs/eis`

### Важные ограничения

**Учебная версия 1С имеет ограничение: 1 запрос в 10 секунд**

Система автоматически обрабатывает ошибки лимита запросов:
- При получении ошибки "Training version limitation reached" система ждёт 10 секунд
- Автоматически повторяет запрос (до 3 попыток)
- Это работает для всех методов обращения к 1С

### Сценарии использования

1. **Регистрация пользователя**:
   - Пользователь выбирает роль (студент/преподаватель)
   - Вводит код из 1С
   - Для студентов выбирает группу
   - Система проверяет код в 1С и получает данные
   - После ввода пароля создаются чаты и контакты

2. **Авторизация**:
   - Пользователь вводит логин (код@фамилия) и пароль
   - Система автоматически синхронизирует данные из 1С
   - Обновляются связи (чаты, контакты, дисциплины)
   - Администратор пропускает синхронизацию

3. **Администратор**:
   - Может создавать сущности в 1С через панели управления
   - Данные автоматически сохраняются в нашей БД
   - Не синхронизируется с 1С при авторизации

### API эндпоинты

#### Для регистрации (публичные)
- `POST /api/auth/register/check-code` - проверка кода в 1С
- `GET /api/auth/register/groups` - получение списка групп
- `POST /api/auth/register` - регистрация с данными из 1С

#### Для администратора
- `GET /api/1c/check-connection` - проверка подключения к 1С
- `GET /api/1c/departments` - получение кафедр
- `GET /api/1c/groups` - получение групп
- `GET /api/1c/disciplines` - получение дисциплин
- `GET /api/1c/teachers` - получение преподавателей
- `GET /api/1c/students` - получение студентов
- `POST /api/admin/1c/departments` - создание кафедры
- `POST /api/admin/1c/groups` - создание группы
- `POST /api/admin/1c/disciplines` - создание дисциплины
- `POST /api/admin/1c/teachers` - создание преподавателя
- `POST /api/admin/1c/students` - создание студента

## Документация

- [API документация 1С](1scfg/api-docs/API_README.md)
- [OpenAPI спецификация](1scfg/api-docs/openapi.yaml)

## Автор

Красавцев Сергей Сергеевич
