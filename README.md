# Веб-сервис чата с интеграцией 1С

Веб-сервис для организации коммуникаций между студентами и преподавателями через веб-чат с интеграцией в учебную информационную систему 1С:Предприятие.

## Технологический стек

- **Frontend**: Next.js (React)
- **Backend**: Node.js + Express
- **База данных**: PostgreSQL
- **WebSocket**: Socket.io для реального времени
- **Интеграция**: REST API для синхронизации с 1С

## Структура проекта

```
app/
├── backend/          # Express API сервер
├── frontend/         # Next.js приложение
├── database/         # SQL схемы и миграции
├── 1scfg/           # Конфигурация и документация интеграции с 1С
└── docs/            # Документация
```

## Установка и запуск

### Требования

- Node.js 16+
- PostgreSQL 12+
- 1С:Предприятие (учебная версия) с настроенным HTTP-сервисом

### Настройка переменных окружения

Создайте файл `.env` в корне проекта на основе `.env.example`:

```bash
cp .env.example .env
```

Отредактируйте `.env` и укажите:
- Параметры подключения к PostgreSQL
- JWT_SECRET (измените на случайный ключ)
- ONE_C_API_URL (URL вашего HTTP-сервиса 1С)

### База данных

1. Создайте базу данных PostgreSQL:
```sql
CREATE DATABASE chat_service_db;
```

2. Выполните схему:
```bash
psql -U postgres -d chat_service_db -f database/schema.sql
```

3. Выполните миграции:
```bash
psql -U postgres -d chat_service_db -f database/migrations/001_add_1c_tables.sql
psql -U postgres -d chat_service_db -f database/migrations/002_update_users_email_nullable.sql
```

4. Загрузите начальные данные:
```bash
psql -U postgres -d chat_service_db -f database/seeds.sql
```

### Backend

```bash
cd backend
npm install
npm run dev
```

Сервер запустится на `http://localhost:3001`

### Frontend

```bash
cd frontend
npm install
npm run dev
```

Приложение запустится на `http://localhost:3000`

## Интеграция с 1С

### Настройка

1. Убедитесь, что HTTP-сервис 1С настроен и доступен по адресу, указанному в `ONE_C_API_URL`
2. По умолчанию используется `http://localhost:3040/PD/hs/eis`

### Важные ограничения

**Учебная версия 1С имеет ограничение: 1 запрос в 10 секунд**

Система автоматически обрабатывает ошибки лимита запросов:
- При получении ошибки "Training version limitation reached" система ждёт 10 секунд
- Автоматически повторяет запрос (до 3 попыток)
- Это работает для всех методов обращения к 1С

### Сценарии использования

1. **Регистрация пользователя**:
   - Пользователь выбирает роль (студент/преподаватель)
   - Вводит код из 1С
   - Для студентов выбирает группу
   - Система проверяет код в 1С и получает данные
   - После ввода пароля создаются чаты и контакты

2. **Авторизация**:
   - Пользователь вводит логин (код@фамилия) и пароль
   - Система автоматически синхронизирует данные из 1С
   - Обновляются связи (чаты, контакты, дисциплины)
   - Администратор пропускает синхронизацию

3. **Администратор**:
   - Может создавать сущности в 1С через панели управления
   - Данные автоматически сохраняются в нашей БД
   - Не синхронизируется с 1С при авторизации

### API эндпоинты

#### Для регистрации (публичные)
- `POST /api/auth/register/check-code` - проверка кода в 1С
- `GET /api/auth/register/groups` - получение списка групп
- `POST /api/auth/register` - регистрация с данными из 1С

#### Для администратора
- `GET /api/1c/check-connection` - проверка подключения к 1С
- `GET /api/1c/departments` - получение кафедр
- `GET /api/1c/groups` - получение групп
- `GET /api/1c/disciplines` - получение дисциплин
- `GET /api/1c/teachers` - получение преподавателей
- `GET /api/1c/students` - получение студентов
- `POST /api/admin/1c/departments` - создание кафедры
- `POST /api/admin/1c/groups` - создание группы
- `POST /api/admin/1c/disciplines` - создание дисциплины
- `POST /api/admin/1c/teachers` - создание преподавателя
- `POST /api/admin/1c/students` - создание студента

## Документация

- [План интеграции с 1С](docs/1C_INTEGRATION_PLAN.md)
- [API документация 1С](1scfg/api-docs/API_README.md)
- [OpenAPI спецификация](1scfg/api-docs/openapi.yaml)

## Автор

Красавцев Сергей Сергеевич
