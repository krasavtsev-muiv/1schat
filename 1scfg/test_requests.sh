#!/bin/bash
# Скрипт для тестирования HTTP сервиса интеграции
# Использование: ./test_requests.sh [BASE_URL]
# Пример: ./test_requests.sh http://localhost:3040/PD/hs/eis

BASE_URL=${1:-"http://localhost:3040/PD/hs/eis"}

# Установка кодировки для корректной работы с русскими символами
export LANG=ru_RU.UTF-8
export LC_ALL=ru_RU.UTF-8

# Функция для отправки POST запроса через временный файл
send_post_request() {
    local url=$1
    local json_data=$2
    
    # Создаем временный файл с уникальным именем
    TEMP_FILE="request_temp_$$_$RANDOM.json"
    RESPONSE_FILE="response_temp_$$_$RANDOM.json"
    
    # Записываем JSON в файл
    cat > "$TEMP_FILE" << EOF
$json_data
EOF
    
    # Отправляем запрос и сохраняем ответ
    curl -X POST "$url" \
      -H "Content-Type: application/json; charset=utf-8" \
      --data-binary "@$TEMP_FILE" \
      -s -o "$RESPONSE_FILE"
    
    # Выводим ответ
    cat "$RESPONSE_FILE"
    echo ""
    
    # Удаляем временные файлы
    rm -f "$TEMP_FILE" "$RESPONSE_FILE"
}

echo "============================================"
echo "Тестирование интеграции HTTP сервиса"
echo "Базовый URL: $BASE_URL"
echo "============================================"
echo ""

# ============================================
# 1. СОЗДАНИЕ КАФЕДР (3 штуки)
# ============================================
echo "1. Создание кафедр..."

send_post_request "$BASE_URL/Departments" '{"Наименование": "Кафедра информационных технологий"}'
send_post_request "$BASE_URL/Departments" '{"Наименование": "Кафедра математики и информатики"}'
send_post_request "$BASE_URL/Departments" '{"Наименование": "Кафедра экономики и управления"}'

echo ""
echo "Кафедры созданы!"
echo ""

# ============================================
# 2. СОЗДАНИЕ ДИСЦИПЛИН (4 штуки)
# ============================================
echo "2. Создание дисциплин..."

send_post_request "$BASE_URL/Disciplines" '{"Наименование": "Основы программирования", "Кафедра": "Кафедра информационных технологий"}'
send_post_request "$BASE_URL/Disciplines" '{"Наименование": "Базы данных и информационные системы", "Кафедра": "Кафедра информационных технологий"}'
send_post_request "$BASE_URL/Disciplines" '{"Наименование": "Математический анализ", "Кафедра": "Кафедра математики и информатики"}'
send_post_request "$BASE_URL/Disciplines" '{"Наименование": "Экономика предприятия", "Кафедра": "Кафедра экономики и управления"}'

echo ""
echo "Дисциплины созданы!"
echo ""

# ============================================
# 3. СОЗДАНИЕ ПРЕПОДАВАТЕЛЕЙ (3 штуки)
# ============================================
echo "3. Создание преподавателей..."

send_post_request "$BASE_URL/Teachers" '{"Фамилия": "Иванов", "Имя": "Иван", "Отчество": "Иванович", "Дисциплина": "Основы программирования"}'
send_post_request "$BASE_URL/Teachers" '{"Фамилия": "Петрова", "Имя": "Мария", "Отчество": "Сергеевна", "Дисциплина": "Математический анализ"}'
send_post_request "$BASE_URL/Teachers" '{"Фамилия": "Сидоров", "Имя": "Александр", "Отчество": "Петрович", "Дисциплина": "Экономика предприятия"}'
send_post_request "$BASE_URL/Teachers" '{"Фамилия": "Кузнецова", "Имя": "Елена", "Отчество": "Викторовна", "Дисциплина": "Базы данных и информационные системы"}'

echo ""
echo "Преподаватели созданы!"
echo ""

# ============================================
# 4. СОЗДАНИЕ ГРУПП (4 штуки)
# ============================================
echo "4. Создание групп..."

send_post_request "$BASE_URL/Groups" '{"Наименование": "ИТ-21", "Кафедра": "Кафедра информационных технологий"}'
send_post_request "$BASE_URL/Groups" '{"Наименование": "ИТ-22", "Кафедра": "Кафедра информационных технологий"}'
send_post_request "$BASE_URL/Groups" '{"Наименование": "МАТ-21", "Кафедра": "Кафедра математики и информатики"}'
send_post_request "$BASE_URL/Groups" '{"Наименование": "ЭКО-21", "Кафедра": "Кафедра экономики и управления"}'

echo ""
echo "Группы созданы!"
echo ""

# ============================================
# 5. СОЗДАНИЕ СТУДЕНТОВ (10 штук)
# ============================================
echo "5. Создание студентов..."

# Группа 1: ИТ-21 (3 студента с одинаковыми дисциплинами)
echo "Создание студентов группы ИТ-21..."
send_post_request "$BASE_URL/Students" '{"Фамилия": "Смирнов", "Имя": "Алексей", "Отчество": "Дмитриевич", "Кафедра": "Кафедра информационных технологий", "Группа": "ИТ-21", "Дисциплины": ["Основы программирования", "Базы данных и информационные системы"]}'
send_post_request "$BASE_URL/Students" '{"Фамилия": "Козлова", "Имя": "Елена", "Отчество": "Владимировна", "Кафедра": "Кафедра информационных технологий", "Группа": "ИТ-21", "Дисциплины": ["Основы программирования", "Базы данных и информационные системы"]}'
send_post_request "$BASE_URL/Students" '{"Фамилия": "Петров", "Имя": "Иван", "Отчество": "Сергеевич", "Кафедра": "Кафедра информационных технологий", "Группа": "ИТ-21", "Дисциплины": ["Основы программирования", "Базы данных и информационные системы"]}'

# Группа 2: ИТ-22 (3 студента той же кафедры, но другая группа, с совпадениями и различиями по дисциплинам)
echo "Создание студентов группы ИТ-22..."
send_post_request "$BASE_URL/Students" '{"Фамилия": "Сидоров", "Имя": "Андрей", "Отчество": "Петрович", "Кафедра": "Кафедра информационных технологий", "Группа": "ИТ-22", "Дисциплины": ["Основы программирования", "Базы данных и информационные системы"]}'
send_post_request "$BASE_URL/Students" '{"Фамилия": "Иванова", "Имя": "Мария", "Отчество": "Александровна", "Кафедра": "Кафедра информационных технологий", "Группа": "ИТ-22", "Дисциплины": ["Основы программирования"]}'
send_post_request "$BASE_URL/Students" '{"Фамилия": "Кузнецов", "Имя": "Дмитрий", "Отчество": "Иванович", "Кафедра": "Кафедра информационных технологий", "Группа": "ИТ-22", "Дисциплины": ["Базы данных и информационные системы"]}'

# Группа 3: МАТ-21 (2 студента с одинаковыми дисциплинами)
echo "Создание студентов группы МАТ-21..."
send_post_request "$BASE_URL/Students" '{"Фамилия": "Новиков", "Имя": "Дмитрий", "Отчество": "Александрович", "Кафедра": "Кафедра математики и информатики", "Группа": "МАТ-21", "Дисциплины": ["Математический анализ"]}'
send_post_request "$BASE_URL/Students" '{"Фамилия": "Морозова", "Имя": "Анна", "Отчество": "Игоревна", "Кафедра": "Кафедра математики и информатики", "Группа": "МАТ-21", "Дисциплины": ["Математический анализ"]}'

# Группа 4: ЭКО-21 (2 студента с разными дисциплинами)
echo "Создание студентов группы ЭКО-21..."
send_post_request "$BASE_URL/Students" '{"Фамилия": "Волков", "Имя": "Сергей", "Отчество": "Николаевич", "Кафедра": "Кафедра экономики и управления", "Группа": "ЭКО-21", "Дисциплины": ["Экономика предприятия"]}'
send_post_request "$BASE_URL/Students" '{"Фамилия": "Лебедева", "Имя": "Ольга", "Отчество": "Викторовна", "Кафедра": "Кафедра экономики и управления", "Группа": "ЭКО-21", "Дисциплины": ["Экономика предприятия"]}'

echo ""
echo "Студенты созданы!"
echo ""

# ============================================
# 6. ПОЛУЧЕНИЕ ДАННЫХ (GET запросы)
# ============================================
echo "6. Получение данных..."

echo ""
echo "Получение списка кафедр:"
curl -X GET "$BASE_URL/Departments" \
  -H "Content-Type: application/json; charset=utf-8" \
  -w "\n"

echo ""
echo "Получение списка дисциплин:"
curl -X GET "$BASE_URL/Disciplines" \
  -H "Content-Type: application/json; charset=utf-8" \
  -w "\n"

echo ""
echo "Получение списка преподавателей:"
curl -X GET "$BASE_URL/Teachers" \
  -H "Content-Type: application/json; charset=utf-8" \
  -w "\n"

echo ""
echo "Получение списка групп:"
curl -X GET "$BASE_URL/Groups" \
  -H "Content-Type: application/json; charset=utf-8" \
  -w "\n"

echo ""
echo "Получение списка студентов:"
curl -X GET "$BASE_URL/Students" \
  -H "Content-Type: application/json; charset=utf-8" \
  -w "\n"

echo ""
echo "Получение полной информации о всех студентах:"
curl -X GET "$BASE_URL/StudentsFull" \
  -H "Content-Type: application/json; charset=utf-8" \
  -w "\n"

echo ""
echo "Получение полной информации о студенте по коду (пример для первого студента):"
curl -X GET "$BASE_URL/StudentsFull/000000001" \
  -H "Content-Type: application/json; charset=utf-8" \
  -w "\n"

echo ""
echo "Получение полной информации о всех преподавателях:"
curl -X GET "$BASE_URL/TeachersFull" \
  -H "Content-Type: application/json; charset=utf-8" \
  -w "\n"

echo ""
echo "Получение полной информации о преподавателе по коду (пример для первого преподавателя):"
curl -X GET "$BASE_URL/TeachersFull/000000001" \
  -H "Content-Type: application/json; charset=utf-8" \
  -w "\n"

echo ""
echo "Получение списка всех пользователей (студентов и преподавателей):"
curl -X GET "$BASE_URL/Users" \
  -H "Content-Type: application/json; charset=utf-8" \
  -w "\n"

echo ""
echo "============================================"
echo "Тестирование завершено!"
echo "============================================"
